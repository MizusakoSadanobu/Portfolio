
### これは何か
- 日経225の過去日足データから、将来の値動きを予測し、儲けるAIです
- 対象銘柄について、日々の始値で売り・中立・買い（空売り）を行い、終値でポジションを精算することを想定し、①どのポジションに賭けるのか、②いくら賭けるのか、を判定する機械学習モデルを構築しました

### なぜ作ったのか
- 儲けたいという安易なモチベーションよるものです

### どのように作ったのか
#### モデル概要
- ポジションを判定する一次モデルと、ポジションのサイズ（いくら賭けるのか）を判定する二次モデルをそれぞれ以下のように設計しました。なお、このようなモデルを日経225の225銘柄についてそれぞれ構築しています。対象銘柄の選定方法については、後ほど触れます
  - 一次モデル：売り・中立・買い（空売り）のポジションを判定
    - 目的変数：着目している銘柄の翌日の騰落率（=(終値-始値)/終値）が一定閾値以上 or 以下か
    - 説明変数：日経225の当日から5日前までの騰落率
    - モデル：ランダムフォレスト
  - 二次モデル：いくら投資するのかを判定
    - 目的変数：一次モデルの判定の正否
    - 説明変数：一次モデルの説明変数 + 一次モデルの予測ラベル（メタラベル）
- 上記のように一次モデルと二次モデルに分けて投資判断を行うメタラベリングの手法は、[ファイナンス機械学習](https://www.amazon.co.jp/%E3%83%95%E3%82%A1%E3%82%A4%E3%83%8A%E3%83%B3%E3%82%B9%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92%E2%80%95%E9%87%91%E8%9E%8D%E5%B8%82%E5%A0%B4%E5%88%86%E6%9E%90%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%81%AE%E7%90%86%E8%AB%96%E3%81%A8%E5%AE%9F%E8%B7%B5-%E3%83%9E%E3%83%AB%E3%82%B3%E3%82%B9%E3%83%BB%E3%83%AD%E3%83%9A%E3%82%B9%E3%83%BB%E3%83%87%E3%83%BB%E3%83%97%E3%83%A9%E3%83%89-ebook/dp/B0834XJQTY)を参考に導入したものです。いくつかの銘柄で一次モデルのみでトレードを行った場合と、二次モデルも導入してトレードを行った場合とで、パフォーマンスを比較したところ、二次モデルを導入することでパフォーマンスが改善することが分かり導入を決めました
- 例えば、以下の図（縦軸：資産、横軸：日数）はある銘柄で比較した例ですが、二次モデルを導入することで、評価期間\*、テスト期間\*のパフォーマンス（最終損益）がそれぞれ+10%程度→+30%程度、▲30%程度→▲10%程度に改善しています（\*評価期間・テスト期間の設計方法については後で触れます）
	- 一次モデルのみでトレード（投資サイズは常に投資可能額の100%） 
![daily](http://drive.google.com/uc?export=view&id=1qWn19FDktrRnUWhsJlVlhAojIr9j2zkx)

	- 一次モデルと二次モデルの組み合わせ
![daily](http://drive.google.com/uc?export=view&id=1yXvIuw2jbQ4aoSW_SOYTbKUeB3-aLHbT)

- 二次モデルは、一次モデルの予測の確からしさを判定するので、予測結果が怪しいものには大きな金額を投資しないことでうまくリスク回避ができているのだと思います

#### 評価方法
- 学習・評価・テストはそれぞれ以下のように設計しています
  - 学習：2014年以前のデータ
  - 評価：2015-2017年のデータ
  - テスト：2018-2020年のデータ
- 評価データは、テスト期間に投資する対象銘柄を選定するために使用しています。評価期間のシャープレシオが上位の銘柄を選定し、テスト期間のパフォーマンスを計測することでこのモデルの評価を行っています
- なお、銘柄選定以外に、以下のようなパラメータも決める必要がありますが、今回は評価期間のパフォーマンスを見てハンドチューニングしています
	- 目的変数の閾値：学習データの設計において、騰落率が何%を上回ったら or 下回ったら売り or 買いとみなすか
	- 一次モデルの予測スコアの閾値：予測スコアが何%を上回ったら or 下回ったら売り or 買いとみなすか
	- 二次モデルの予測スコアを投資サイズに変換する際のパラメータ：今回はシグモイド関数を使用しているため、定数項とgain項の2つのパラメータをチューニングする必要あり
- ハンドチューニングとしたのは、これらのパラメータを評価期間のパフォーマンスでチューニングすると、評価期間で過学習してしまい、テスト期間ではデタラメな結果を出すことが分かったためです

### 儲かりそうか
- このロジックにより年間30%程度のリターンが見込める結果が出たのですが、先ほど述べたパラメータ設定に詰めの甘さがあるため、身銭を切って投資をすることに恐怖を感じている次第です。。
 - 以下の図が、評価期間で選定した上位銘柄のテスト期間でのパフォーマンスです。最終損益だけに着目すると、上位5, 10, 20銘柄のいずれの場合も+50%程度の利益が出ていることが分かります（オレンジのライン）。しかし、こちらは信用取引の利息コストを考慮せずに計算してしまったものなので、実際には、30%程度のリターンになるのではないかと思います。3倍のレバレッジをかければ100%程度リターンが期待できるということですので、悪くない気がします
	 - 評価データ上位5名柄
![daily](http://drive.google.com/uc?export=view&id=1mi7Cy-J-CQaz4Ywn33aBacBnLd1zlueb)
	 - 評価データ上位10名柄
![daily](http://drive.google.com/uc?export=view&id=1vuW5rpLilQjLSHB_kk62bTNI96zqa8zR)
	 - 評価データ上位20名柄
![daily](http://drive.google.com/uc?export=view&id=1my6xCcCXh6lCVKUZ021xxQFs7G_HH85v)

 - 上記の図で、青色のラインのパフォーマンスが非常に良いのですが、こちらは「評価期間でシャープレシオが上位だった銘柄の評価期間におけるパフォーマンス」ですので、ある意味良くてい当然のものです
 - 評価期間とテスト期間のシャープレシオの関係も確認しておきます。以下の通り、評価期間とテスト期間のシャープレシオには正の相関があり、評価期間で上位の銘柄を選定することは、悪くないように思えます

![daily](http://drive.google.com/uc?export=view&id=1RS6p5DYKxPehf1qu4yJ0Jj-ubSDoh4KE)

- ここまでポジティブな面に触れてきましたが、パフォーマンスを時系列で見ると自信が無くなってきます。。リターンの大半は、直近1年間のコロナバブルで稼いだもののようなので、今後も稼げるモデルなのか、疑問が残ります

### 最後に
- 日経225の銘柄を対象に、日々の始値で売り・中立・買い（空売り）を行い、終値でポジションを精算するためのAIを構築しました
- 二次モデルを導入することで、パフォーマンスが向上したように思えましたが、モデルの複雑性（≒チューニングすべきパラメータ数）が増し、結果、信頼性を損ねてしまったように思います。まずは、シンプルなモデルで検証を行うべきだったと反省しています

### 参考文献
- [ファイナンス機械学習](https://www.amazon.co.jp/%E3%83%95%E3%82%A1%E3%82%A4%E3%83%8A%E3%83%B3%E3%82%B9%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92%E2%80%95%E9%87%91%E8%9E%8D%E5%B8%82%E5%A0%B4%E5%88%86%E6%9E%90%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%81%AE%E7%90%86%E8%AB%96%E3%81%A8%E5%AE%9F%E8%B7%B5-%E3%83%9E%E3%83%AB%E3%82%B3%E3%82%B9%E3%83%BB%E3%83%AD%E3%83%9A%E3%82%B9%E3%83%BB%E3%83%87%E3%83%BB%E3%83%97%E3%83%A9%E3%83%89-ebook/dp/B0834XJQTY)
- [アセットマネージャーのためのファイナンス機械学習](https://www.amazon.co.jp/dp/B08QTX81PF/ref=dp-kindle-redirect?_encoding=UTF8&btkr=1)
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTEzNjc1NTkwMzksNzMwOTk4MTE2XX0=
-->